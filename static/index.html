<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Transcript-Aware Auto-Editor</title>
<style>
:root {
  --bg: #1a1a2e;
  --bg-surface: #16213e;
  --bg-card: #1f2b47;
  --bg-card-hover: #263352;
  --bg-deleted: #3d1a1a;
  --text: #e0e0e0;
  --text-muted: #8892a4;
  --text-dim: #5a6578;
  --accent: #4fc3f7;
  --accent-hover: #29b6f6;
  --danger: #ef5350;
  --danger-bg: #4a1c1c;
  --success: #66bb6a;
  --border: #2a3a5c;
  --removed-badge: #ef5350;
  --highlight: rgba(79, 195, 247, 0.15);
  --font-mono: 'SF Mono', 'Fira Code', 'Consolas', 'Monaco', monospace;
  --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  --radius: 6px;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: var(--font-sans);
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
}

/* Header */
header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 24px;
  background: var(--bg-surface);
  border-bottom: 1px solid var(--border);
}
header h1 { font-size: 16px; font-weight: 600; letter-spacing: 0.5px; }
header button {
  background: none;
  border: 1px solid var(--border);
  color: var(--text-muted);
  padding: 6px 14px;
  border-radius: var(--radius);
  cursor: pointer;
  font-size: 13px;
}
header button:hover { border-color: var(--accent); color: var(--accent); }

/* Sections */
.section {
  padding: 16px 24px;
  border-bottom: 1px solid var(--border);
}
.section-title {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-muted);
  margin-bottom: 10px;
}

/* Input row */
.input-row {
  display: flex;
  gap: 10px;
  align-items: center;
}
.input-row input[type="text"] {
  flex: 1;
  background: var(--bg-card);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 8px 12px;
  border-radius: var(--radius);
  font-family: var(--font-mono);
  font-size: 13px;
}
.input-row input:focus { outline: none; border-color: var(--accent); }

.btn {
  background: var(--accent);
  color: #000;
  border: none;
  padding: 8px 18px;
  border-radius: var(--radius);
  cursor: pointer;
  font-weight: 600;
  font-size: 13px;
  white-space: nowrap;
}
.btn:hover { background: var(--accent-hover); }
.btn:disabled { opacity: 0.4; cursor: not-allowed; }
.btn-danger { background: var(--danger); color: #fff; }
.btn-danger:hover { background: #f44336; }
.btn-outline {
  background: none;
  border: 1px solid var(--border);
  color: var(--text-muted);
}
.btn-outline:hover { border-color: var(--accent); color: var(--accent); }

/* Hidden utility */
.hidden { display: none !important; }

/* Progress log */
#progress-log {
  background: #0d1117;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 12px;
  font-family: var(--font-mono);
  font-size: 12px;
  max-height: 180px;
  overflow-y: auto;
  color: var(--text-muted);
  line-height: 1.6;
}
#progress-log .line { white-space: pre-wrap; word-break: break-all; }
#progress-log .line-error { color: var(--danger); }
#progress-log .line-done { color: var(--success); }

/* Video player */
.video-controls {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 10px;
}
.video-controls label { font-size: 13px; color: var(--text-muted); cursor: pointer; }
.video-controls input[type="checkbox"] { margin-right: 4px; }
video {
  width: 100%;
  max-height: 320px;
  border-radius: var(--radius);
  background: #000;
}

/* Two-column transcript */
.transcript-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  max-height: 55vh;
}
.transcript-col {
  overflow-y: auto;
  padding: 0;
}
.transcript-col + .transcript-col { border-left: 1px solid var(--border); }
.col-header {
  position: sticky;
  top: 0;
  background: var(--bg-surface);
  padding: 8px 14px;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-muted);
  border-bottom: 1px solid var(--border);
  z-index: 2;
}

/* Block cards */
.block-card {
  padding: 10px 14px;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  transition: background 0.15s;
  position: relative;
}
.block-card:hover { background: var(--bg-card-hover); }
.block-card.active { background: var(--highlight); }
.block-card .block-meta {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-dim);
  margin-bottom: 4px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.block-card .block-text {
  font-size: 13px;
  line-height: 1.5;
}

/* Left panel: deleted styling */
.block-card.deleted-view {
  background: var(--bg-deleted);
}
.block-card.deleted-view .block-text {
  text-decoration: line-through;
  color: var(--text-dim);
}
.removed-badge {
  display: inline-block;
  background: var(--removed-badge);
  color: #fff;
  font-size: 9px;
  font-weight: 700;
  padding: 2px 6px;
  border-radius: 3px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* Right panel: delete button */
.delete-btn {
  background: none;
  border: none;
  color: var(--text-dim);
  font-size: 18px;
  cursor: pointer;
  padding: 6px 10px;
  border-radius: 3px;
  line-height: 1;
}
.delete-btn:hover { color: var(--danger); background: var(--danger-bg); }

/* Hidden deleted card on right panel */
.block-card.deleted-edit { display: none; }

/* Export bar */
.export-row {
  display: flex;
  gap: 16px;
  align-items: center;
  flex-wrap: wrap;
}
.export-row label {
  font-size: 12px;
  color: var(--text-muted);
  display: flex;
  align-items: center;
  gap: 6px;
}
.export-row select, .export-row input[type="range"], .export-row input[type="number"], .export-row input[type="text"] {
  background: var(--bg-card);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 5px 8px;
  border-radius: var(--radius);
  font-size: 13px;
}
.export-row input[type="range"] {
  width: 120px;
  accent-color: var(--accent);
}
.export-row select { padding: 5px 10px; }
.range-val {
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--accent);
  min-width: 40px;
}

/* Summary */
#summary-bar {
  padding: 10px 24px;
  background: var(--bg-surface);
  border-bottom: 1px solid var(--border);
  font-size: 13px;
  color: var(--text-muted);
}
#summary-bar span { margin-right: 24px; }
#summary-bar .val { color: var(--accent); font-family: var(--font-mono); }

/* Advanced panel */
#advanced-panel {
  padding: 16px 24px;
  border-bottom: 1px solid var(--border);
  background: var(--bg-surface);
}
.advanced-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 12px;
}
.advanced-grid label {
  display: flex;
  flex-direction: column;
  gap: 4px;
  font-size: 12px;
  color: var(--text-muted);
}
.advanced-grid input {
  background: var(--bg-card);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 6px 10px;
  border-radius: var(--radius);
  font-family: var(--font-mono);
  font-size: 13px;
}

/* Export result */
#export-result {
  padding: 12px 24px;
  font-family: var(--font-mono);
  font-size: 12px;
  border-bottom: 1px solid var(--border);
}
#export-result.success { background: #1a2e1a; color: var(--success); }
#export-result.error { background: var(--danger-bg); color: var(--danger); }

/* Scrollbar */
::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }
</style>
</head>
<body>

<header>
  <h1>Transcript-Aware Auto-Editor</h1>
  <button id="advancedToggle" onclick="toggleAdvanced()">Advanced Mode</button>
</header>

<!-- Step 1: Video path + transcribe -->
<div class="section">
  <div class="section-title">Video</div>
  <div class="input-row">
    <input type="text" id="videoPath" placeholder="/path/to/video.mp4" spellcheck="false">
    <button class="btn" id="transcribeBtn" onclick="startTranscribe()">Transcribe</button>
    <button class="btn btn-outline" id="loadExistingBtn" onclick="loadExisting()">Load Existing</button>
  </div>
</div>

<!-- Progress log -->
<div class="section hidden" id="progress-section">
  <div class="section-title">Transcription Progress</div>
  <div id="progress-log"></div>
</div>

<!-- Video player -->
<div class="section hidden" id="video-section">
  <div class="video-controls">
    <label><input type="checkbox" id="syncToggle" checked> Sync video to transcript</label>
    <label><input type="checkbox" id="scrollSyncToggle" checked> Sync scroll between panels</label>
  </div>
  <video id="videoPlayer" controls preload="metadata"></video>
</div>

<!-- Summary bar -->
<div id="summary-bar" class="hidden">
  <span>Blocks: <span class="val" id="sumTotal">0</span></span>
  <span>Removed: <span class="val" id="sumRemoved">0</span></span>
  <span>Time cut: <span class="val" id="sumTimeCut">0.0s</span></span>
  <span>Reduction: <span class="val" id="sumReduction">0%</span></span>
</div>

<!-- Transcript panels -->
<div id="transcript-section" class="hidden">
  <div class="transcript-grid">
    <div class="transcript-col" id="leftPanel">
      <div class="col-header">Original</div>
    </div>
    <div class="transcript-col" id="rightPanel">
      <div class="col-header">Edit (click x to delete)</div>
    </div>
  </div>
</div>

<!-- Export controls -->
<div class="section hidden" id="export-section">
  <div class="section-title">Export</div>
  <div class="export-row">
    <label>Margin:
      <input type="range" id="marginSlider" min="0" max="1" step="0.05" value="0.10">
      <span class="range-val" id="marginVal">0.10s</span>
    </label>
    <label>Export:
      <select id="exportFormat">
        <option value="final-cut-pro">Final Cut Pro</option>
        <option value="premiere">Premiere</option>
        <option value="resolve">DaVinci Resolve</option>
        <option value="clip-sequence">Clip Sequence</option>
        <option value="video">Video</option>
      </select>
    </label>
    <button class="btn btn-outline" id="undoBtn" onclick="undoDelete()" disabled>Undo</button>
    <button class="btn" id="exportBtn" onclick="startExport()">Export</button>
  </div>
</div>

<!-- Advanced panel -->
<div id="advanced-panel" class="hidden">
  <div class="section-title">Advanced Options</div>
  <div class="advanced-grid">
    <label>Silent speed <input type="text" id="silentSpeed" placeholder="99999 (cut)"></label>
    <label>Sounded speed <input type="text" id="soundedSpeed" placeholder="1"></label>
    <label>Video codec <input type="text" id="videoCodec" placeholder="auto"></label>
    <label>Audio codec <input type="text" id="audioCodec" placeholder="auto"></label>
    <label>FFmpeg args <input type="text" id="ffmpegArgs" placeholder="-crf 22 -preset veryfast"></label>
    <label>Edit method <input type="text" id="editMethod" placeholder="audio:threshold=4%"></label>
  </div>
</div>

<!-- Export result -->
<div id="export-result" class="hidden"></div>

<script>
// ── State ──
let blocks = [];       // {id, index, start, end, text, deleted}
let undoStack = [];    // block IDs
let srtPath = "";
let origSrtPath = "";
let jsonPath = "";
let currentHighlight = -1;
let deletedRanges = [];

// ── DOM refs ──
const $videoPath = document.getElementById("videoPath");
const $transcribeBtn = document.getElementById("transcribeBtn");
const $loadExistingBtn = document.getElementById("loadExistingBtn");
const $progressSection = document.getElementById("progress-section");
const $progressLog = document.getElementById("progress-log");
const $videoSection = document.getElementById("video-section");
const $videoPlayer = document.getElementById("videoPlayer");
const $syncToggle = document.getElementById("syncToggle");
const $scrollSyncToggle = document.getElementById("scrollSyncToggle");
const $transcriptSection = document.getElementById("transcript-section");
const $leftPanel = document.getElementById("leftPanel");
const $rightPanel = document.getElementById("rightPanel");
const $exportSection = document.getElementById("export-section");
const $marginSlider = document.getElementById("marginSlider");
const $marginVal = document.getElementById("marginVal");
const $undoBtn = document.getElementById("undoBtn");
const $summaryBar = document.getElementById("summary-bar");
const $exportResult = document.getElementById("export-result");

// ── Utilities ──
function fmt(sec) {
  const m = Math.floor(sec / 60);
  const s = (sec % 60).toFixed(1);
  return m > 0 ? `${m}:${s.padStart(4, '0')}` : `${s}s`;
}

function logLine(msg, cls = "") {
  const div = document.createElement("div");
  div.className = "line" + (cls ? ` line-${cls}` : "");
  div.textContent = msg;
  $progressLog.appendChild(div);
  $progressLog.scrollTop = $progressLog.scrollHeight;
}

// ── Transcription ──
function startTranscribe() {
  const path = $videoPath.value.trim();
  if (!path) return;

  $transcribeBtn.disabled = true;
  $progressSection.classList.remove("hidden");
  $progressLog.innerHTML = "";

  fetch("/api/transcribe", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ video_path: path }),
  }).then(response => {
    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let buf = "";

    function read() {
      reader.read().then(({ done, value }) => {
        if (done) { $transcribeBtn.disabled = false; return; }
        buf += decoder.decode(value, { stream: true });
        const lines = buf.split("\n");
        buf = lines.pop();
        for (const line of lines) {
          if (!line.startsWith("data: ")) continue;
          try {
            const evt = JSON.parse(line.slice(6));
            if (evt.type === "progress") logLine(evt.message);
            else if (evt.type === "start") logLine(evt.message);
            else if (evt.type === "error") logLine(evt.message, "error");
            else if (evt.type === "done") {
              logLine(evt.message, "done");
              srtPath = evt.srt_path;
              origSrtPath = evt.orig_srt_path;
              jsonPath = evt.json_path;
              loadTranscript();
            }
          } catch (_) {}
        }
        read();
      });
    }
    read();
  }).catch(err => {
    logLine("Request failed: " + err.message, "error");
    $transcribeBtn.disabled = false;
  });
}

// ── Load Existing ──
function loadExisting() {
  const path = $videoPath.value.trim();
  if (!path) return;

  // Derive paths from video path
  const base = path.replace(/\.[^.]+$/, "");
  srtPath = base + ".srt";
  origSrtPath = base + ".srt.orig";
  jsonPath = base + ".json";
  loadTranscript();
}

// ── Load Transcript ──
function loadTranscript() {
  const videoPath = $videoPath.value.trim();

  // Set up video player
  $videoPlayer.src = `/media?path=${encodeURIComponent(videoPath)}`;
  $videoSection.classList.remove("hidden");

  // Load SRT blocks (use orig if available, fall back to edited)
  fetch(`/api/srt?path=${encodeURIComponent(origSrtPath)}`)
    .then(r => {
      if (!r.ok) return fetch(`/api/srt?path=${encodeURIComponent(srtPath)}`).then(r2 => r2.json());
      return r.json();
    })
    .then(data => {
      blocks = data.map((b, i) => ({
        id: i,
        index: b.index,
        start: b.start,
        end: b.end,
        text: b.text,
        deleted: false,
      }));
      undoStack = [];
      renderTranscript();
      $transcriptSection.classList.remove("hidden");
      $exportSection.classList.remove("hidden");
      $summaryBar.classList.remove("hidden");
      updateSummary();
    })
    .catch(err => {
      $progressSection.classList.remove("hidden");
      logLine("Failed to load SRT: " + err.message, "error");
    });
}

// ── Render ──
function renderTranscript() {
  // Clear panels (keep headers)
  $leftPanel.innerHTML = '<div class="col-header">Original</div>';
  $rightPanel.innerHTML = '<div class="col-header">Edit (click \u2715 to delete)</div>';

  for (const b of blocks) {
    // Left panel card
    const leftCard = document.createElement("div");
    leftCard.className = "block-card" + (b.deleted ? " deleted-view" : "");
    leftCard.dataset.id = b.id;
    leftCard.dataset.start = b.start;
    leftCard.dataset.end = b.end;
    leftCard.innerHTML = `
      <div class="block-meta">
        <span>${b.index ?? b.id + 1}  ${fmt(b.start)}\u2013${fmt(b.end)}</span>
        ${b.deleted ? '<span class="removed-badge">Removed</span>' : ""}
      </div>
      <div class="block-text">${escHtml(b.text)}</div>
    `;
    leftCard.addEventListener("click", () => seekTo(b.start));
    $leftPanel.appendChild(leftCard);

    // Right panel card
    const rightCard = document.createElement("div");
    rightCard.className = "block-card" + (b.deleted ? " deleted-edit" : "");
    rightCard.dataset.id = b.id;
    rightCard.dataset.start = b.start;
    rightCard.dataset.end = b.end;
    rightCard.innerHTML = `
      <div class="block-meta">
        <span>${b.index ?? b.id + 1}  ${fmt(b.start)}\u2013${fmt(b.end)}</span>
        <button class="delete-btn" title="Delete block" onclick="deleteBlock(${b.id})">\u2715</button>
      </div>
      <div class="block-text">${escHtml(b.text)}</div>
    `;
    rightCard.addEventListener("click", (e) => {
      if (e.target.closest(".delete-btn")) return;
      seekTo(b.start);
    });
    $rightPanel.appendChild(rightCard);
  }

  // Set up scroll sync
  setupScrollSync();
}

function escHtml(s) {
  return s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
}

// ── Block deletion ──
function deleteBlock(id) {
  const b = blocks.find(x => x.id === id);
  if (!b || b.deleted) return;
  b.deleted = true;
  undoStack.push(id);
  $undoBtn.disabled = false;

  // Update left card
  const leftCard = $leftPanel.querySelector(`[data-id="${id}"]`);
  if (leftCard) {
    leftCard.classList.add("deleted-view");
    leftCard.querySelector(".block-meta").innerHTML = `
      <span>${b.index ?? b.id + 1}  ${fmt(b.start)}\u2013${fmt(b.end)}</span>
      <span class="removed-badge">Removed</span>
    `;
  }

  // Hide right card
  const rightCard = $rightPanel.querySelector(`[data-id="${id}"]`);
  if (rightCard) rightCard.classList.add("deleted-edit");

  updateSummary();
}

function undoDelete() {
  if (!undoStack.length) return;
  const id = undoStack.pop();
  const b = blocks.find(x => x.id === id);
  if (!b) return;
  b.deleted = false;

  // Update left card
  const leftCard = $leftPanel.querySelector(`[data-id="${id}"]`);
  if (leftCard) {
    leftCard.classList.remove("deleted-view");
    leftCard.querySelector(".block-meta").innerHTML = `
      <span>${b.index ?? b.id + 1}  ${fmt(b.start)}\u2013${fmt(b.end)}</span>
    `;
  }

  // Show right card
  const rightCard = $rightPanel.querySelector(`[data-id="${id}"]`);
  if (rightCard) rightCard.classList.remove("deleted-edit");

  $undoBtn.disabled = undoStack.length === 0;
  updateSummary();
}

// ── Summary ──
function updateSummary() {
  const total = blocks.length;
  const removed = blocks.filter(b => b.deleted).length;
  const cutDuration = blocks.filter(b => b.deleted).reduce((s, b) => s + (b.end - b.start), 0);
  const totalDuration = blocks.length ? blocks[blocks.length - 1].end : 0;
  const pct = totalDuration > 0 ? ((cutDuration / totalDuration) * 100).toFixed(1) : "0.0";

  document.getElementById("sumTotal").textContent = total;
  document.getElementById("sumRemoved").textContent = removed;
  document.getElementById("sumTimeCut").textContent = fmt(cutDuration);
  document.getElementById("sumReduction").textContent = pct + "%";
}

// ── Video sync ──
$videoPlayer.addEventListener("timeupdate", () => {
  if (!$syncToggle.checked) return;
  const t = $videoPlayer.currentTime;
  let active = -1;
  for (const b of blocks) {
    if (t >= b.start && t < b.end) { active = b.id; break; }
  }
  if (active === currentHighlight) return;
  currentHighlight = active;

  // Update highlight
  $leftPanel.querySelectorAll(".block-card.active").forEach(c => c.classList.remove("active"));
  $rightPanel.querySelectorAll(".block-card.active").forEach(c => c.classList.remove("active"));

  if (active >= 0) {
    const lc = $leftPanel.querySelector(`[data-id="${active}"]`);
    const rc = $rightPanel.querySelector(`[data-id="${active}"]`);
    if (lc) { lc.classList.add("active"); scrollIntoViewIfNeeded(lc, $leftPanel); }
    if (rc && !rc.classList.contains("deleted-edit")) {
      rc.classList.add("active");
      scrollIntoViewIfNeeded(rc, $rightPanel);
    }
  }
});

function seekTo(time) {
  $videoPlayer.currentTime = time;
}

function scrollIntoViewIfNeeded(el, container) {
  const rect = el.getBoundingClientRect();
  const cRect = container.getBoundingClientRect();
  if (rect.top < cRect.top + 40 || rect.bottom > cRect.bottom) {
    el.scrollIntoView({ behavior: "smooth", block: "center" });
  }
}

// ── Scroll sync between panels ──
let scrollSyncing = false;
function setupScrollSync() {
  const left = $leftPanel;
  const right = $rightPanel;

  left.addEventListener("scroll", () => {
    if (!$scrollSyncToggle.checked || scrollSyncing) return;
    scrollSyncing = true;
    const pct = left.scrollTop / (left.scrollHeight - left.clientHeight || 1);
    right.scrollTop = pct * (right.scrollHeight - right.clientHeight || 1);
    requestAnimationFrame(() => { scrollSyncing = false; });
  });

  right.addEventListener("scroll", () => {
    if (!$scrollSyncToggle.checked || scrollSyncing) return;
    scrollSyncing = true;
    const pct = right.scrollTop / (right.scrollHeight - right.clientHeight || 1);
    left.scrollTop = pct * (left.scrollHeight - left.clientHeight || 1);
    requestAnimationFrame(() => { scrollSyncing = false; });
  });
}

// ── Margin slider ──
$marginSlider.addEventListener("input", () => {
  $marginVal.textContent = parseFloat($marginSlider.value).toFixed(2) + "s";
});

// ── Advanced mode ──
function toggleAdvanced() {
  const panel = document.getElementById("advanced-panel");
  panel.classList.toggle("hidden");
  document.getElementById("advancedToggle").textContent =
    panel.classList.contains("hidden") ? "Advanced Mode" : "Simple Mode";
}

// ── Export ──
function startExport() {
  const videoPath = $videoPath.value.trim();
  if (!videoPath) return;

  const $btn = document.getElementById("exportBtn");
  $btn.disabled = true;
  $btn.textContent = "Exporting...";
  $exportResult.classList.add("hidden");

  // First, get server-side diff for accurate JSON timestamps
  const keptBlocks = blocks.filter(b => !b.deleted).map(b => ({
    index: b.index,
    start: b.start,
    end: b.end,
    text: b.text,
  }));

  fetch("/api/diff", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      orig_srt_path: origSrtPath,
      json_path: jsonPath,
      kept_blocks: keptBlocks,
    }),
  })
  .then(r => r.json())
  .then(diffData => {
    if (diffData.error) throw new Error(diffData.error);
    deletedRanges = diffData.deleted_ranges;

    // Update summary with server-computed values
    if (diffData.summary) {
      const s = diffData.summary;
      document.getElementById("sumTotal").textContent = s.total_blocks;
      document.getElementById("sumRemoved").textContent = s.removed_blocks;
      document.getElementById("sumTimeCut").textContent = fmt(s.cut_duration);
      document.getElementById("sumReduction").textContent = s.reduction_pct + "%";
    }

    // Now export
    const payload = {
      video_path: videoPath,
      deleted_ranges: deletedRanges,
      margin: parseFloat($marginSlider.value),
      export: document.getElementById("exportFormat").value,
    };

    // Advanced options
    const silentSpeed = document.getElementById("silentSpeed").value.trim();
    const soundedSpeed = document.getElementById("soundedSpeed").value.trim();
    const videoCodec = document.getElementById("videoCodec").value.trim();
    const audioCodec = document.getElementById("audioCodec").value.trim();
    const ffmpegArgs = document.getElementById("ffmpegArgs").value.trim();
    const editMethod = document.getElementById("editMethod").value.trim();

    if (silentSpeed) payload.silent_speed = silentSpeed;
    if (soundedSpeed) payload.sounded_speed = soundedSpeed;
    if (videoCodec) payload.video_codec = videoCodec;
    if (audioCodec) payload.audio_codec = audioCodec;
    if (ffmpegArgs) payload.ffmpeg_args = ffmpegArgs;
    if (editMethod) payload.edit_method = editMethod;

    return fetch("/api/export", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });
  })
  .then(r => r.json())
  .then(result => {
    $exportResult.classList.remove("hidden");
    if (result.success) {
      $exportResult.className = "success";
      $exportResult.textContent = `${result.message}\n\nCommand: ${result.command}`;
      if (result.stdout) $exportResult.textContent += `\n\n${result.stdout}`;
    } else {
      $exportResult.className = "error";
      $exportResult.textContent = `Export failed: ${result.error}\n\nCommand: ${result.command || "N/A"}`;
    }
  })
  .catch(err => {
    $exportResult.classList.remove("hidden");
    $exportResult.className = "error";
    $exportResult.textContent = "Error: " + err.message;
  })
  .finally(() => {
    $btn.disabled = false;
    $btn.textContent = "Export";
  });
}

// ── Keyboard shortcuts ──
document.addEventListener("keydown", (e) => {
  // Ctrl+Z / Cmd+Z: undo
  if ((e.ctrlKey || e.metaKey) && e.key === "z" && !e.shiftKey) {
    // Don't intercept if focused on an input
    if (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA") return;
    e.preventDefault();
    undoDelete();
  }
});
</script>
</body>
</html>
